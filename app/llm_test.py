"""
–°–∫—Ä–∏–ø—Ç –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏ –∏ –∏–∑–≤–ª–µ—á–µ–Ω–∏—è –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –∏–∑ —Ç–µ–Ω–¥–µ—Ä–Ω—ã—Ö –ª–æ—Ç–æ–≤.

–≠—Ç–æ—Ç –ø–∞–π–ø–ª–∞–π–Ω –≤—ã–ø–æ–ª–Ω—è–µ—Ç —Å–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏:
1.  **–ü–∞—Ä—Å–∏–Ω–≥**: –ß–∏—Ç–∞–µ—Ç –∏—Å—Ö–æ–¥–Ω—ã–π —Ñ–∞–π–ª –∏ —Ä–∞–∑–¥–µ–ª—è–µ—Ç –µ–≥–æ –Ω–∞ –æ—Ç–¥–µ–ª—å–Ω—ã–µ –ª–æ—Ç—ã. –ö–∞–∂–¥—ã–π –ª–æ—Ç
    —Ä–∞–∑–±–∏–≤–∞–µ—Ç—Å—è –Ω–∞ –æ—Ç–¥–µ–ª—å–Ω—ã–µ –∑–∞–ø–∏—Å–∏ (–ø–æ–∑–∏—Ü–∏–∏).
2.  **–ö–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è**: –î–ª—è –∫–∞–∂–¥–æ–≥–æ –ª–æ—Ç–∞ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è –æ—Å–Ω–æ–≤–Ω–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è —Ä–∞–±–æ—Ç
    (–Ω–∞–ø—Ä–∏–º–µ—Ä, "–Ω—É–ª–µ–≤–æ–π —Ü–∏–∫–ª") —Å –ø–æ–º–æ—â—å—é –¥–≤—É—Ö—ç—Ç–∞–ø–Ω–æ–≥–æ –ø—Ä–æ—Ü–µ—Å—Å–∞:
    a. –ë—ã—Å—Ç—Ä–∞—è –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è –ø–æ –∑–∞–≥–æ–ª–æ–≤–∫—É –∏ –ø–µ—Ä–≤—ã–º –∑–∞–ø–∏—Å—è–º.
    b. –î–µ—Ç–∞–ª—å–Ω–∞—è –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è –ø–æ –∫–∞–∂–¥–æ–π –∑–∞–ø–∏—Å–∏, –µ—Å–ª–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –ø–µ—Ä–≤–æ–≥–æ —à–∞–≥–∞
       –Ω–µ–æ–¥–Ω–æ–∑–Ω–∞—á–µ–Ω.
3.  **–ò–∑–≤–ª–µ—á–µ–Ω–∏–µ**: –ù–∞ –æ—Å–Ω–æ–≤–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –≤—ã–±–∏—Ä–∞–µ—Ç—Å—è —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π
    –ø—Ä–æ–º–ø—Ç. –° –µ–≥–æ –ø–æ–º–æ—â—å—é –∏–∑ —Ç–µ–∫—Å—Ç–∞ –ª–æ—Ç–∞ –∏–∑–≤–ª–µ–∫–∞—é—Ç—Å—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ
    –ø–∞—Ä–∞–º–µ—Ç—Ä—ã (–Ω–∞–ø—Ä–∏–º–µ—Ä, –æ–±—ä–µ–º—ã, –º–∞—Ç–µ—Ä–∏–∞–ª—ã, –µ–¥–∏–Ω–∏—Ü—ã –∏–∑–º–µ—Ä–µ–Ω–∏—è).
4.  **–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ**: –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω–æ–≥–æ –ª–æ—Ç–∞ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤
    –æ—Ç–¥–µ–ª—å–Ω—ã–π, –≤–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–π JSON-—Ñ–∞–π–ª.
"""

import json
import logging
import math
import os
import re
from collections import Counter
from dataclasses import dataclass, field
from datetime import datetime
from pathlib import Path
from typing import Any, Dict, List, Optional

import requests
from dotenv import load_dotenv

load_dotenv()

# –ò–º–ø–æ—Ä—Ç –ø—Ä–æ–º–ø—Ç–æ–≤ –∏–∑ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –º–æ–¥—É–ª—è
from prompts import (
    CLASSIFIER_PROMPT,
    GROUNDWORKS_CATEGORY_PROMPT,
    SINGLE_RECORD_CLASSIFIER_PROMPT,
)


# --- 1. –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø ---
@dataclass
class Config:
    """
    –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π –∫–ª–∞—Å—Å –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –≤—Å–µ—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫ —Å–∫—Ä–∏–ø—Ç–∞.

    –°–æ–±–∏—Ä–∞–µ—Ç –≤—Å–µ "–º–∞–≥–∏—á–µ—Å–∫–∏–µ" –∑–Ω–∞—á–µ–Ω–∏—è –∏ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã, –∑–∞–≥—Ä—É–∂–∞–µ–º—ã–µ –∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö
    –æ–∫—Ä—É–∂–µ–Ω–∏—è, –≤ –æ–¥–Ω–æ–º –º–µ—Å—Ç–µ –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è.

    Attributes:
        OLLAMA_URL (str): URL-–∞–¥—Ä–µ—Å —Å–µ—Ä–≤–µ—Ä–∞ Ollama (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–π).
        TOKEN (str): –¢–æ–∫–µ–Ω –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –¥–ª—è Ollama (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–π).
        MODEL_NAME (str): –ù–∞–∑–≤–∞–Ω–∏–µ –º–æ–¥–µ–ª–∏ Ollama.
        BATCH_SIZE (int): –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø–∏—Å–µ–π –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–∞ –æ–¥–∏–Ω –∑–∞–ø—Ä–æ—Å –∫ LLM.
        TIMEOUT (int): –¢–∞–π–º–∞—É—Ç –æ–∂–∏–¥–∞–Ω–∏—è –æ—Ç–≤–µ—Ç–∞ –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞ –≤ —Å–µ–∫—É–Ω–¥–∞—Ö.
        INPUT_FILE (Path): –ü—É—Ç—å –∫ –∏—Å—Ö–æ–¥–Ω–æ–º—É —Ñ–∞–π–ª—É —Å –ª–æ—Ç–∞–º–∏.
        OUTPUT_DIR (Path): –ö–∞—Ç–∞–ª–æ–≥ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∏—Ç–æ–≥–æ–≤—ã—Ö JSON-—Ñ–∞–π–ª–æ–≤.
        VERIFY_SSL (bool): –§–ª–∞–≥ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ SSL-—Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞ —Å–µ—Ä–≤–µ—Ä–∞.
    """

    # <--- –£–∫–∞–∂–∏—Ç–µ –∞–¥—Ä–µ—Å –≤–∞—à–µ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞ Ollama –≤ .env
    OLLAMA_URL: str = os.getenv("OLLAMA_URL")
    # <--- –ï—Å–ª–∏ —Ç—Ä–µ–±—É–µ—Ç—Å—è —Ç–æ–∫–µ–Ω, —É–∫–∞–∂–∏—Ç–µ –µ–≥–æ –≤ .env
    TOKEN: str = os.getenv("OLLAMA_TOKEN", "")
    MODEL_NAME: str = os.getenv("OLLAMA_MODEL", "llama3")
    BATCH_SIZE: int = 10
    TIMEOUT: int = 300
    INPUT_FILE: Path = Path("test_10_positions.md")
    OUTPUT_DIR: Path = Path("tender_categories")
    VERIFY_SSL: bool = False


# --- 2. –ö–õ–ê–°–°–´ –î–ê–ù–ù–´–• ---


@dataclass
class ExtractedParameter:
    """–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –æ–¥–Ω–æ–≥–æ –∏–∑–≤–ª–µ—á–µ–Ω–Ω–æ–≥–æ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞."""

    category: str
    parameter: str
    value: Any
    unit: Optional[str]


@dataclass
class Record:
    """–ü—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ –æ–¥–Ω–æ–π –∑–∞–ø–∏—Å–∏ (–ø–æ–∑–∏—Ü–∏–∏) –≤–Ω—É—Ç—Ä–∏ –ª–æ—Ç–∞."""

    record_id: int
    text: str
    title: str


@dataclass
class LotData:
    """
    –û—Å–Ω–æ–≤–Ω–æ–π –∫–ª–∞—Å—Å, –∞–≥—Ä–µ–≥–∏—Ä—É—é—â–∏–π –≤—Å—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –ø–æ –æ–¥–Ω–æ–º—É –ª–æ—Ç—É.

    –•—Ä–∞–Ω–∏—Ç –∫–∞–∫ –∏—Å—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ, —Ç–∞–∫ –∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∏—Ö –æ–±—Ä–∞–±–æ—Ç–∫–∏:
    –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—É—é –∫–∞—Ç–µ–≥–æ—Ä–∏—é, –∏–∑–≤–ª–µ—á–µ–Ω–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∏ –≤–æ–∑–º–æ–∂–Ω—ã–µ –æ—à–∏–±–∫–∏.
    """

    lot_number: int
    lot_title: str
    raw_text: str
    records: List[Record] = field(default_factory=list)
    detected_category: Optional[str] = None
    extracted_params: List[ExtractedParameter] = field(default_factory=list)
    error: Optional[str] = None


# --- 3. –ú–ê–†–®–†–£–¢–ò–ó–ê–¢–û–† –ü–†–û–ú–ü–¢–û–í ---
EXTRACTION_PROMPTS = {
    "–Ω—É–ª–µ–≤–æ–π —Ü–∏–∫–ª": GROUNDWORKS_CATEGORY_PROMPT,
    # "–æ—Ç–¥–µ–ª–∫–∞": FINISHING_WORKS_PROMPT, # <-- –ü—Ä–∏–º–µ—Ä, –∫–∞–∫ –¥–æ–±–∞–≤–ª—è—Ç—å –Ω–æ–≤—ã–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
}

# --- 4. –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò –ò –õ–û–ì–ò–ö–ê ---

logging.basicConfig(level=logging.INFO, format="%(asctime)s - %(levelname)s - %(message)s")


def parse_source_file(file_path: Path) -> List[LotData]:
    """
    –ü–∞—Ä—Å–∏—Ç –∏—Å—Ö–æ–¥–Ω—ã–π —Ñ–∞–π–ª –∏ —Ä–∞–∑–¥–µ–ª—è–µ—Ç –µ–≥–æ –Ω–∞ –æ–±—ä–µ–∫—Ç—ã LotData.

    Args:
        file_path (Path): –ü—É—Ç—å –∫ —Ñ–∞–π–ª—É —Å –¥–∞–Ω–Ω—ã–º–∏.

    Returns:
        List[LotData]: –°–ø–∏—Å–æ–∫ –æ–±—ä–µ–∫—Ç–æ–≤ —Å –¥–∞–Ω–Ω—ã–º–∏ –ø–æ –∫–∞–∂–¥–æ–º—É –ª–æ—Ç—É.
                       –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø—É—Å—Ç–æ–π —Å–ø–∏—Å–æ–∫, –µ—Å–ª–∏ —Ñ–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω
                       –∏–ª–∏ –≤ –Ω–µ–º –Ω–µ—Ç –ª–æ—Ç–æ–≤.
    """
    if not file_path.exists():
        logging.error(f"–§–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω: {file_path}")
        return []
    text = file_path.read_text(encoding="utf-8")
    pattern = re.compile(
        r"# –î–µ—Ç–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –æ—Ç—á–µ—Ç –ø–æ –ø–æ–∑–∏—Ü–∏—è–º –¥–ª—è –ª–æ—Ç–∞\s*-\s*–õ–æ—Ç ‚Ññ(?P<lot_number>\d+)\s*-\s*(?P<lot_title>.+)",
        re.IGNORECASE,
    )
    matches = list(pattern.finditer(text))
    if not matches:
        logging.error(f"–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ –ª–æ—Ç—ã –≤ —Ñ–∞–π–ª–µ {file_path}. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ñ–æ—Ä–º–∞—Ç –¥–∞–Ω–Ω—ã—Ö.")
        return []

    lots = []
    for i, match in enumerate(matches):
        start = match.end()
        end = matches[i + 1].start() if i + 1 < len(matches) else len(text)
        lot = LotData(
            lot_number=int(match.group("lot_number")),
            lot_title=match.group("lot_title").strip(),
            raw_text=text[start:end].strip(),
        )
        lot.records = parse_lot_records(lot.raw_text)
        lots.append(lot)
    logging.info(f"–ù–∞–π–¥–µ–Ω–æ –∏ —Ä–∞—Å–ø–∞—Ä—Å–µ–Ω–æ {len(lots)} –ª–æ—Ç–æ–≤ –∏–∑ —Ñ–∞–π–ª–∞.")
    return lots


def parse_lot_records(raw_text: str) -> List[Record]:
    """
    –†–∞–∑–¥–µ–ª—è–µ—Ç —Å—ã—Ä–æ–π —Ç–µ–∫—Å—Ç –ª–æ—Ç–∞ –Ω–∞ –æ—Ç–¥–µ–ª—å–Ω—ã–µ –∑–∞–ø–∏—Å–∏ (–æ–±—ä–µ–∫—Ç—ã Record).

    Args:
        raw_text (str): –¢–µ–∫—Å—Ç –æ–¥–Ω–æ–≥–æ –ª–æ—Ç–∞.

    Returns:
        List[Record]: –°–ø–∏—Å–æ–∫ –∑–∞–ø–∏—Å–µ–π, –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö –≤ —Ç–µ–∫—Å—Ç–µ.
    """
    blocks = re.split(r"(?=\n\*\*–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ:)", raw_text.strip(), flags=re.IGNORECASE)
    records = []
    for i, block in enumerate(filter(None, blocks)):
        title_match = re.search(r"\*\*–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ:?\*\*\s*(.*)", block.strip())
        records.append(
            Record(
                record_id=i,
                text=block.strip(),
                title=(title_match.group(1).strip() if title_match else "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –ø–æ–∑–∏—Ü–∏—è"),
            )
        )
    return records


def run_llm_request(prompt: str, user_content: str, config: Config) -> Optional[Dict[str, Any]]:
    """
    –í—ã–ø–æ–ª–Ω—è–µ—Ç —Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π –∑–∞–ø—Ä–æ—Å –∫ LLM –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ—Ç–≤–µ—Ç –≤ –≤–∏–¥–µ —Å–ª–æ–≤–∞—Ä—è.

    –§—É–Ω–∫—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç POST-–∑–∞–ø—Ä–æ—Å, –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –≤–æ–∑–º–æ–∂–Ω—ã–µ –æ—à–∏–±–∫–∏ —Å–µ—Ç–∏ –∏
    —Ç–∞–π–º–∞—É—Ç—ã, –∞ —Ç–∞–∫–∂–µ –ø—ã—Ç–∞–µ—Ç—Å—è –∏–∑–≤–ª–µ—á—å –∏–∑ –æ—Ç–≤–µ—Ç–∞ –º–æ–¥–µ–ª–∏ –ø–µ—Ä–≤—ã–π –≤–∞–ª–∏–¥–Ω—ã–π
    JSON-–æ–±—ä–µ–∫—Ç.

    Args:
        prompt (str): –°–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç –¥–ª—è LLM.
        user_content (str): –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –∫–æ–Ω—Ç–µ–Ω—Ç (—Ç–µ–∫—Å—Ç –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞).
        config (Config): –û–±—ä–µ–∫—Ç –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏.

    Returns:
        Optional[Dict[str, Any]]: –°–ª–æ–≤–∞—Ä—å —Å –¥–∞–Ω–Ω—ã–º–∏ –∏–∑ JSON-–æ—Ç–≤–µ—Ç–∞ –∏–ª–∏ None
                                  –≤ —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏.
    """
    try:
        headers = {"Content-Type": "application/json"}
        if config.TOKEN:
            headers["Authorization"] = f"Bearer {config.TOKEN}"
        response = requests.post(
            config.OLLAMA_URL,
            json={
                "model": config.MODEL_NAME,
                "messages": [
                    {"role": "system", "content": prompt},
                    {"role": "user", "content": user_content},
                ],
                "stream": False,
                "options": {"temperature": 0.0},
            },
            headers=headers,
            timeout=config.TIMEOUT,
            verify=config.VERIFY_SSL,
        )
        response.raise_for_status()
        j = response.json()
        if "message" not in j or "content" not in j["message"]:
            logging.error(f"–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –æ—Ç–≤–µ—Ç –æ—Ç LLM: {j.get('error', '–û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –ø–æ–ª–µ message.content')}")
            return None

        response_text = j["message"]["content"]
        json_match = re.search(r"\{.*\}", response_text, re.DOTALL)
        if json_match:
            return json.loads(json_match.group(0))

        logging.warning(f"–í –æ—Ç–≤–µ—Ç–µ LLM –Ω–µ –Ω–∞–π–¥–µ–Ω JSON-–æ–±—ä–µ–∫—Ç. –û—Ç–≤–µ—Ç: {response_text[:200]}...")
        return None

    except requests.Timeout:
        logging.error("–ó–∞–ø—Ä–æ—Å –∫ LLM –ø—Ä–µ–≤—ã—Å–∏–ª —Ç–∞–π–º–∞—É—Ç.")
    except requests.RequestException as e:
        logging.error(f"–û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ –∫ LLM: {e}")
    except json.JSONDecodeError:
        logging.error("–ù–µ —É–¥–∞–ª–æ—Å—å –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞—Ç—å JSON –∏–∑ –æ—Ç–≤–µ—Ç–∞ LLM.")
    except Exception as e:
        logging.error(f"–ù–µ–ø—Ä–µ–¥–≤–∏–¥–µ–Ω–Ω–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–∞–±–æ—Ç–µ —Å LLM: {e}")
    return None


def process_lot(lot: LotData, config: Config):
    """
    –í—ã–ø–æ–ª–Ω—è–µ—Ç –ø–æ–ª–Ω—ã–π —Ü–∏–∫–ª –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ–¥–Ω–æ–≥–æ –ª–æ—Ç–∞.

    –ü—Ä–æ—Ü–µ—Å—Å –≤–∫–ª—é—á–∞–µ—Ç –≤ —Å–µ–±—è –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—é, –≤—ã–±–æ—Ä –ø—Ä–æ–º–ø—Ç–∞ –∏ –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ
    –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –ø–æ –±–∞—Ç—á–∞–º.

    Args:
        lot (LotData): –û–±—ä–µ–∫—Ç –ª–æ—Ç–∞ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏.
        config (Config): –û–±—ä–µ–∫—Ç –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏.
    """
    logging.info(f"--- –û–±—Ä–∞–±–æ—Ç–∫–∞ –õ–æ—Ç–∞ ‚Ññ{lot.lot_number}: '{lot.lot_title}' ---")
    if not lot.records:
        logging.warning(f"–õ–æ—Ç ‚Ññ{lot.lot_number}: –Ω–µ—Ç –∑–∞–ø–∏—Å–µ–π –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞.")
        return

    # --- –®–ê–ì 1: –ë—ã—Å—Ç—Ä–∞—è –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è –ø–æ —Å—Ä–µ–∑—É –∑–∞–ø–∏—Å–µ–π ---
    logging.info("–®–∞–≥ 1: –ë—ã—Å—Ç—Ä–∞—è –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è...")
    sample_records = lot.records[: min(10, len(lot.records))]
    classifier_input = f"lot_title: {lot.lot_title}\nraw_text: {' '.join(rec.title for rec in sample_records)}"
    category_response = run_llm_request(CLASSIFIER_PROMPT, classifier_input, config)
    detected_category = category_response.get("category") if category_response else None

    # --- –®–ê–ì 2: –î–µ—Ç–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –ø—Ä–∏ –Ω–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ ---
    if not detected_category or detected_category in ["–ø—Ä–æ—á–µ–µ", "–≥–µ–Ω–ø–æ–¥—Ä—è–¥"]:
        logging.warning(
            f"–†–µ–∑—É–ª—å—Ç–∞—Ç –±—ã—Å—Ç—Ä–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω–µ–æ–¥–Ω–æ–∑–Ω–∞—á–µ–Ω ('{detected_category}'). –ó–∞–ø—É—Å–∫–∞—é –¥–µ—Ç–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑..."
        )
        all_categories = []
        for record in lot.records:
            # –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –æ—á–µ–≤–∏–¥–Ω–æ –Ω–µ—Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–µ –∑–∞–ø–∏—Å–∏
            if "–æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ" in record.title.lower() or "–≥–∞—Ä–∞–Ω—Ç–∏" in record.title.lower():
                continue
            cat_resp = run_llm_request(SINGLE_RECORD_CLASSIFIER_PROMPT, record.title, config)
            if cat_resp and "category" in cat_resp:
                all_categories.append(cat_resp["category"])
        if all_categories:
            # –í—ã–±–∏—Ä–∞–µ–º —Å–∞–º—É—é —á–∞—Å—Ç—É—é –∫–∞—Ç–µ–≥–æ—Ä–∏—é
            detected_category = Counter(all_categories).most_common(1)[0][0]

    lot.detected_category = detected_category
    if not lot.detected_category:
        lot.error = "–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é –ª–æ—Ç–∞ –¥–∞–∂–µ –ø–æ—Å–ª–µ –¥–µ—Ç–∞–ª—å–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞."
        logging.error(f"–õ–æ—Ç ‚Ññ{lot.lot_number}: {lot.error}")
        return
    logging.info(f"–õ–æ—Ç—É ‚Ññ{lot.lot_number} –ø—Ä–∏—Å–≤–æ–µ–Ω–∞ –∏—Ç–æ–≥–æ–≤–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è: '{lot.detected_category}'")

    # --- –®–ê–ì 3: –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –ø–æ –±–∞—Ç—á–∞–º ---
    extraction_prompt = EXTRACTION_PROMPTS.get(lot.detected_category)
    if not extraction_prompt:
        logging.warning(f"–î–ª—è –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ '{lot.detected_category}' –Ω–µ –Ω–∞–π–¥–µ–Ω –ø—Ä–æ–º–ø—Ç. –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –ø—Ä–æ–ø—É—â–µ–Ω–æ.")
        return

    logging.info(f"–®–∞–≥ 3: –ó–∞–ø—É—Å–∫–∞—é –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –¥–ª—è '{lot.detected_category}'.")
    num_batches = math.ceil(len(lot.records) / config.BATCH_SIZE)
    for i in range(num_batches):
        batch_start = i * config.BATCH_SIZE
        batch_end = batch_start + config.BATCH_SIZE
        current_batch = lot.records[batch_start:batch_end]
        logging.info(f"  - –û—Ç–ø—Ä–∞–≤–∫–∞ –ø–∞–∫–µ—Ç–∞ {i+1}/{num_batches}...")

        batch_prompt_lines = [f"[RECORD_ID={record.record_id}]\n{record.text}" for record in current_batch]
        batch_to_process = "\n---END_OF_RECORD---\n".join(batch_prompt_lines)

        parsed_data = run_llm_request(extraction_prompt, batch_to_process, config)
        if not parsed_data:
            logging.warning(f"  - –ü–∞–∫–µ—Ç {i+1} –Ω–µ –≤–µ—Ä–Ω—É–ª –¥–∞–Ω–Ω—ã—Ö.")
            continue

        extracted_count = 0
        for params_list in parsed_data.values():
            for params_dict in params_list:
                lot.extracted_params.append(ExtractedParameter(**params_dict))
                extracted_count += 1
        logging.info(f"  - [–û–ö] –ü–∞–∫–µ—Ç {i+1} –æ–±—Ä–∞–±–æ—Ç–∞–Ω. –ò–∑–≤–ª–µ—á–µ–Ω–æ {extracted_count} –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤.")


def save_results(lot: LotData, config: Config):
    """
    –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –∏–∑–≤–ª–µ—á–µ–Ω–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ª–æ—Ç–∞ –≤ –≤–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–π JSON-—Ñ–∞–π–ª.

    Args:
        lot (LotData): –û–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–π –æ–±—ä–µ–∫—Ç –ª–æ—Ç–∞.
        config (Config): –û–±—ä–µ–∫—Ç –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏.
    """
    if not lot.extracted_params:
        logging.info(f"–î–ª—è –ª–æ—Ç–∞ ‚Ññ{lot.lot_number} –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è.")
        return

    config.OUTPUT_DIR.mkdir(parents=True, exist_ok=True)

    # –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–º–µ–Ω–∏ —Ñ–∞–π–ª–∞: <–∏—Å—Ö–æ–¥–Ω—ã–π_—Ñ–∞–π–ª>.<–Ω–æ–º–µ—Ä_–ª–æ—Ç–∞>.<–∫–∞—Ç–µ–≥–æ—Ä–∏—è>_<–≤—Ä–µ–º—è>.json
    ts = datetime.now().strftime("%Y%m%d-%H%M%S")
    src_name = config.INPUT_FILE.stem
    category_slug = lot.detected_category.replace(" ", "_")
    filename = f"{src_name}.lot_{lot.lot_number}.{category_slug}_{ts}.json"

    filepath = config.OUTPUT_DIR / filename
    output_data = [param.__dict__ for param in lot.extracted_params]

    with open(filepath, "w", encoding="utf-8") as f:
        json.dump(output_data, f, indent=2, ensure_ascii=False)
    logging.info(f"‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –¥–ª—è –ª–æ—Ç–∞ ‚Ññ{lot.lot_number} —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤: {filepath}")


def main():
    """–ì–ª–∞–≤–Ω–∞—è –∏—Å–ø–æ–ª–Ω—è—é—â–∞—è —Ñ—É–Ω–∫—Ü–∏—è —Å–∫—Ä–∏–ø—Ç–∞."""
    config = Config()
    if not config.OLLAMA_URL or not config.MODEL_NAME:
        logging.error("–ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è OLLAMA_URL –∏ OLLAMA_MODEL –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã. –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Ä–∞–±–æ—Ç—ã.")
        return

    all_lots = parse_source_file(config.INPUT_FILE)
    if not all_lots:
        logging.info("–ù–µ—Ç –ª–æ—Ç–æ–≤ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏. –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Ä–∞–±–æ—Ç—ã.")
        return

    for lot in all_lots:
        process_lot(lot, config)
        save_results(lot, config)

    logging.info("\nüéâ –ü–∞–π–ø–ª–∞–π–Ω –∑–∞–≤–µ—Ä—à–µ–Ω!")


if __name__ == "__main__":
    main()
