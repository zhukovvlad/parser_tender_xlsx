# app/go_module/sync_wrapper.py

"""
–°–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–µ –æ–±–µ—Ä—Ç–∫–∏ –¥–ª—è –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–≥–æ GoApiClient.

–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:
-----------
–ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –≤ —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–º –∫–æ–¥–µ –¥–ª—è –≤—ã–∑–æ–≤–∞ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã—Ö –º–µ—Ç–æ–¥–æ–≤ GoApiClient:
- parse_with_gemini.py: –û—Å–Ω–æ–≤–Ω–æ–π –º–æ–¥—É–ª—å –ø–∞—Ä—Å–∏–Ω–≥–∞ —Ç–µ–Ω–¥–µ—Ä–æ–≤
- app/workers/gemini/tasks.py: Celery –∑–∞–¥–∞—á–∏ –¥–ª—è AI –æ–±—Ä–∞–±–æ—Ç–∫–∏

–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞:
------------
–ö–∞–∂–¥–∞—è —Ñ—É–Ω–∫—Ü–∏—è:
1. –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç –≤–Ω—É—Ç—Ä–µ–Ω–Ω—é—é async —Ñ—É–Ω–∫—Ü–∏—é
2. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç GoApiClient (—Å–æ–∑–¥–∞–µ—Ç—Å—è –Ω–æ–≤—ã–π –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –≤—ã–∑–æ–≤–∞)
3. –í—ã–ø–æ–ª–Ω—è–µ—Ç –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π –≤—ã–∑–æ–≤ Go API
4. –ó–∞–∫—Ä—ã–≤–∞–µ—Ç HTTP —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ (—á–µ—Ä–µ–∑ context manager –≤ GoApiClient)
5. –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç —á–µ—Ä–µ–∑ run_async()

–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ Event Loop:
---------------------
–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —É—Ç–∏–ª–∏—Ç–∞ run_async() –∏–∑ app.utils.async_runner, –∫–æ—Ç–æ—Ä–∞—è:
- –ï—Å–ª–∏ event loop –ù–ï –∑–∞–ø—É—â–µ–Ω ‚Üí –∏—Å–ø–æ–ª—å–∑—É–µ—Ç asyncio.run()
- –ï—Å–ª–∏ event loop –£–ñ–ï –∑–∞–ø—É—â–µ–Ω ‚Üí —Å–æ–∑–¥–∞–µ—Ç –æ—Ç–¥–µ–ª—å–Ω—ã–π –ø–æ—Ç–æ–∫ —Å –Ω–æ–≤—ã–º loop

–≠—Ç–æ –∫—Ä–∏—Ç–∏—á–Ω–æ –¥–ª—è Celery –≤–æ—Ä–∫–µ—Ä–æ–≤, –≥–¥–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –∞–∫—Ç–∏–≤–Ω—ã–π event loop.

–ò—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:
--------------------
1. import_tender_sync():
   - –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç –ø–æ–ª–Ω—ã–π —Ç–µ–Ω–¥–µ—Ä —Å –ª–æ—Ç–∞–º–∏ –≤ Go –ë–î (–ü—Ä–æ—Ü–µ—Å—Å 1)
   - –¢—Ä–∏–≥–≥–µ—Ä–∏—Ç –∏–Ω–¥–µ–∫—Å–∞—Ü–∏—é –Ω–æ–≤—ã—Ö –ø–æ–∑–∏—Ü–∏–π –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏
   - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è: parse_with_gemini.py

2. update_lot_ai_results_sync():
   - –û–±–Ω–æ–≤–ª—è–µ—Ç AI-—Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –ª–æ—Ç–∞ (–ü—Ä–æ—Ü–µ—Å—Å 1)
   - –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –∫–∞—Ç–µ–≥–æ—Ä–∏—é, —Å–º–µ—Ç—É, —Ç–∞–±–ª–∏—Ü—ã —Ä–∞–±–æ—Ç –∏ –¥—Ä—É–≥–∏–µ –¥–∞–Ω–Ω—ã–µ –æ—Ç Gemini
   - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è: workers/gemini/tasks.py, parse_with_gemini.py

–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫:
----------------
- –í—Å–µ –∏—Å–∫–ª—é—á–µ–Ω–∏—è –ª–æ–≥–∏—Ä—É—é—Ç—Å—è —Å –ø–æ–ª–Ω—ã–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º
- –ü—Ä–æ–±—Ä–∞—Å—ã–≤–∞—é—Ç—Å—è –∫–∞–∫ RuntimeError –¥–ª—è retry –≤ Celery
- –û—à–∏–±–∫–∏ –∏–Ω–¥–µ–∫—Å–∞—Ü–∏–∏ –Ω–µ –ø—Ä–µ—Ä—ã–≤–∞—é—Ç –∏–º–ø–æ—Ä—Ç —Ç–µ–Ω–¥–µ—Ä–∞

–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:
------------------
- –ö–∞–∂–¥—ã–π –≤—ã–∑–æ–≤ —Å–æ–∑–¥–∞–µ—Ç –Ω–æ–≤—ã–π HTTP –∫–ª–∏–µ–Ω—Ç (httpx.AsyncClient)
- –ö–ª–∏–µ–Ω—Ç—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–∫—Ä—ã–≤–∞—é—Ç—Å—è —á–µ—Ä–µ–∑ async context manager
- –ù–µ—Ç —É—Ç–µ—á–µ–∫ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π –∏–ª–∏ –ø–∞–º—è—Ç–∏
- –ü–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è —Ä–µ–¥–∫–∏—Ö –≤—ã–∑–æ–≤–æ–≤ (1-2 —Ä–∞–∑–∞ –Ω–∞ —Ç–µ–Ω–¥–µ—Ä)

–ë—É–¥—É—â–∏–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏:
-------------------
- –ú–∏–≥—Ä–∞—Ü–∏—è –Ω–∞ async Celery tasks –¥–ª—è –Ω–∞—Ç–∏–≤–Ω–æ–π –ø–æ–¥–¥–µ—Ä–∂–∫–∏ async/await
- Connection pooling –¥–ª—è —á–∞—Å—Ç—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
- Batch –æ–ø–µ—Ä–∞—Ü–∏–∏ –¥–ª—è –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π
"""

import logging
from typing import Any, Dict, Tuple

from app.utils.async_runner import run_async

from .go_client import GoApiClient

log = logging.getLogger(__name__)


def import_tender_sync(tender_data: Dict[str, Any]) -> Tuple[str, Dict[str, int]]:
    """
    –°–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –æ–±–µ—Ä—Ç–∫–∞ –¥–ª—è GoApiClient.import_full_tender().

    –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –ø–æ–ª–Ω—ã–π JSON —Ç–µ–Ω–¥–µ—Ä–∞ –Ω–∞ Go-—Å–µ—Ä–≤–µ—Ä –¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –≤ –ë–î (–ü—Ä–æ—Ü–µ—Å—Å 1).
    –ü—Ä–∏ –Ω–∞–ª–∏—á–∏–∏ –Ω–æ–≤—ã—Ö –ø–æ–∑–∏—Ü–∏–π –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ç—Ä–∏–≥–≥–µ—Ä–∏—Ç –∑–∞–¥–∞—á—É –∏–Ω–¥–µ–∫—Å–∞—Ü–∏–∏.

    Workflow:
    ---------
    1. –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç tender_data –≤ Go API (/import-tender)
    2. Go —Å–æ–∑–¥–∞–µ—Ç –∑–∞–ø–∏—Å–∏: tenders, lots, position_items
    3. –ü–æ–ª—É—á–∞–µ—Ç tender_db_id –∏ –º–∞–ø–ø–∏–Ω–≥ lot_ids
    4. –ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Ñ–ª–∞–≥ new_catalog_items_pending
    5. –ï—Å–ª–∏ –µ—Å—Ç—å –Ω–æ–≤—ã–µ –ø–æ–∑–∏—Ü–∏–∏ ‚Üí –∑–∞–ø—É—Å–∫–∞–µ—Ç run_indexing_task.delay()

    Args:
        tender_data: –ü–æ–ª–Ω—ã–π JSON —Ç–µ–Ω–¥–µ—Ä–∞, —Å–æ–¥–µ—Ä–∂–∞—â–∏–π:
            - tender_id: ID –≤ ETP —Å–∏—Å—Ç–µ–º–µ
            - lots: —Å–ø–∏—Å–æ–∫ –ª–æ—Ç–æ–≤ —Å –ø–æ–∑–∏—Ü–∏—è–º–∏
            - metadata: –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ (–∑–∞–∫–∞–∑—á–∏–∫, —Å—Ä–æ–∫–∏ –∏ —Ç.–¥.)

    Returns:
        Tuple[str, Dict[str, int]]:
            - tender_db_id: Database ID —Å–æ–∑–¥–∞–Ω–Ω–æ–≥–æ —Ç–µ–Ω–¥–µ—Ä–∞ (—Å—Ç—Ä–æ–∫–∞)
            - lot_ids_map: {external_lot_id: db_lot_id} –º–∞–ø–ø–∏–Ω–≥
              –ù–∞–ø—Ä–∏–º–µ—Ä: {"lot_1": 42, "lot_2": 43}

    Raises:
        RuntimeError: –ü—Ä–∏ –æ—à–∏–±–∫–∞—Ö —Å–µ—Ç–∏, —Ç–∞–π–º–∞—É—Ç–∞—Ö –∏–ª–∏ –ø—Ä–æ–±–ª–µ–º–∞—Ö Go —Å–µ—Ä–≤–µ—Ä–∞
        ValueError: –ï—Å–ª–∏ Go –≤–µ—Ä–Ω—É–ª –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –æ—Ç–≤–µ—Ç (–æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç tender_db_id)

    Example:
        >>> data = {"tender_id": "123", "lots": [...]}
        >>> tender_id, lots_map = import_tender_sync(data)
        >>> print(f"Created tender {tender_id}, lots: {lots_map}")

    Note:
        - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —É–≤–µ–ª–∏—á–µ–Ω–Ω—ã–π —Ç–∞–π–º–∞—É—Ç (600s) –¥–ª—è –±–æ–ª—å—à–∏—Ö —Ç–µ–Ω–¥–µ—Ä–æ–≤
        - –û—à–∏–±–∫–∏ –∏–Ω–¥–µ–∫—Å–∞—Ü–∏–∏ –Ω–µ –ø—Ä–µ—Ä—ã–≤–∞—é—Ç –∏–º–ø–æ—Ä—Ç
        - –ó–∞–ø—É—Å–∫–∞–µ—Ç Celery –∑–∞–¥–∞—á—É –∏–Ω–¥–µ–∫—Å–∞—Ü–∏–∏ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ
    """

    async def _async_import():
        client = GoApiClient()
        log.debug("–°–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –æ–±–µ—Ä—Ç–∫–∞: –∏–º–ø–æ—Ä—Ç —Ç–µ–Ω–¥–µ—Ä–∞ —á–µ—Ä–µ–∑ GoApiClient")
        response = await client.import_full_tender(tender_data)

        # –í–∞–ª–∏–¥–∞—Ü–∏—è –æ—Ç–≤–µ—Ç–∞
        if not response:
            raise ValueError("–ü—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç –æ—Ç Go-—Å–µ—Ä–≤–µ—Ä–∞")

        log.debug(f"–û—Ç–≤–µ—Ç –æ—Ç Go-—Å–µ—Ä–≤–µ—Ä–∞: {response}")

        # –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Ä–∞–∑–Ω—ã—Ö —Ñ–æ—Ä–º–∞—Ç–æ–≤ –æ—Ç–≤–µ—Ç–∞
        tender_db_id = response.get("tender_db_id") or response.get("db_id")
        if not tender_db_id:
            raise ValueError(f"Go-—Å–µ—Ä–≤–µ—Ä –Ω–µ –≤–µ—Ä–Ω—É–ª tender_db_id. –û—Ç–≤–µ—Ç: {response}")

        lot_ids_map = response.get("lot_ids_map") or response.get("lots_id") or {}

        # (–ù–û–í–û–ï) –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ñ–ª–∞–≥ –¥–ª—è event-driven –∏–Ω–¥–µ–∫—Å–∞—Ü–∏–∏
        new_catalog_items = response.get("new_catalog_items_pending", False)

        log.info(f"‚úÖ –¢–µ–Ω–¥–µ—Ä –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω: db_id={tender_db_id}, –ª–æ—Ç–æ–≤={len(lot_ids_map)}")

        # (–ù–û–í–û–ï) –ï—Å–ª–∏ –µ—Å—Ç—å –Ω–æ–≤—ã–µ pending –ø–æ–∑–∏—Ü–∏–∏, –∑–∞–ø—É—Å–∫–∞–µ–º –∏–Ω–¥–µ–∫—Å–∞—Ü–∏—é
        if new_catalog_items:
            log.info("üîî –û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –Ω–æ–≤—ã–µ 'pending' –ø–æ–∑–∏—Ü–∏–∏, –∑–∞–ø—É—Å–∫–∞–µ–º –∏–Ω–¥–µ–∫—Å–∞—Ü–∏—é...")
            try:
                # –õ–µ–Ω–∏–≤—ã–π –∏–º–ø–æ—Ä—Ç —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å —Ü–∏–∫–ª–∏—á–µ—Å–∫–∏—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
                from app.workers.rag_catalog.tasks import run_indexing_task

                # –ó–∞–ø—É—Å–∫–∞–µ–º –∑–∞–¥–∞—á—É –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ
                run_indexing_task.delay()
                log.info("‚úÖ –ó–∞–¥–∞—á–∞ –∏–Ω–¥–µ–∫—Å–∞—Ü–∏–∏ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ –≤ –æ—á–µ—Ä–µ–¥—å Celery")
            except Exception as e:
                log.warning(f"‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø—É—Å—Ç–∏—Ç—å –∑–∞–¥–∞—á—É –∏–Ω–¥–µ–∫—Å–∞—Ü–∏–∏: {e}", exc_info=True)
                # –ù–µ –ø—Ä–µ—Ä—ã–≤–∞–µ–º –∏–º–ø–æ—Ä—Ç –∏–∑-–∑–∞ –æ—à–∏–±–∫–∏ –∏–Ω–¥–µ–∫—Å–∞—Ü–∏–∏

        return str(tender_db_id), lot_ids_map

    try:
        return run_async(_async_import())
    except Exception as e:
        log.exception(f"‚ùå –û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞ —Ç–µ–Ω–¥–µ—Ä–∞: {e}")
        raise RuntimeError(f"–ù–µ —É–¥–∞–ª–æ—Å—å –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç–µ–Ω–¥–µ—Ä: {e}") from e


def update_lot_ai_results_sync(
    lot_db_id: str,
    category: str,
    ai_data: Dict[str, Any],
    processed_at: str = "",
    tender_id: str = "",  # –î–æ–±–∞–≤–ª–µ–Ω –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
) -> Dict[str, Any]:
    """
    –°–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –æ–±–µ—Ä—Ç–∫–∞ –¥–ª—è GoApiClient.update_lot_key_parameters().

    –û–±–Ω–æ–≤–ª—è–µ—Ç AI-—Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã (–∫–ª—é—á–µ–≤—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã) –¥–ª—è –ª–æ—Ç–∞ –≤ –ë–î (–ü—Ä–æ—Ü–µ—Å—Å 1).
    –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –¥–∞–Ω–Ω—ã–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ Gemini: –∫–∞—Ç–µ–≥–æ—Ä–∏—é, —Å–º–µ—Ç—É, —Ç–∞–±–ª–∏—Ü—ã —Ä–∞–±–æ—Ç –∏ –¥—Ä—É–≥–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã.

    Workflow:
    ---------
    1. –§–æ—Ä–º–∏—Ä—É–µ—Ç payload –≤ —Ñ–æ—Ä–º–∞—Ç–µ lot_key_parameters
    2. –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –≤ Go API (POST /lots/{lot_db_id}/ai-results)
    3. Go –æ–±–Ω–æ–≤–ª—è–µ—Ç –ø–æ–ª–µ lot_key_parameters –≤ —Ç–∞–±–ª–∏—Ü–µ lots
    4. –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ

    Args:
        lot_db_id: Database ID –ª–æ—Ç–∞ (–ù–ï external_id!)
            –ü–æ–ª—É—á–∞–µ—Ç—Å—è –∏–∑ lot_ids_map –ø–æ—Å–ª–µ import_tender_sync()
        category: –ö–∞—Ç–µ–≥–æ—Ä–∏—è —Ä–∞–±–æ—Ç, –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–∞—è Gemini AI
            –ù–∞–ø—Ä–∏–º–µ—Ä: "–ú–æ—Å—Ç–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ", "–ö–æ—Ç–ª–æ–≤–∞–Ω", "–°–≤–∞–π–Ω—ã–µ —Ä–∞–±–æ—Ç—ã"
        ai_data: –°–ª–æ–≤–∞—Ä—å —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏ AI –æ–±—Ä–∞–±–æ—Ç–∫–∏:
            - cmu_table: —Ç–∞–±–ª–∏—Ü–∞ —Ä–∞–±–æ—Ç —Å –ø–æ–∑–∏—Ü–∏—è–º–∏
            - smeta_summary: –∏—Ç–æ–≥–∏ –ø–æ —Å–º–µ—Ç–µ
            - key_metrics: –∫–ª—é—á–µ–≤—ã–µ –º–µ—Ç—Ä–∏–∫–∏
            - –∏ –¥—Ä—É–≥–∏–µ –ø–æ–ª—è, —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ –¥–ª—è –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
        processed_at: ISO 8601 timestamp –º–æ–º–µ–Ω—Ç–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏
            –§–æ—Ä–º–∞—Ç: "2024-12-16T14:30:00Z"
        tender_id: ID —Ç–µ–Ω–¥–µ—Ä–∞ –≤ ETP (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏)

    Returns:
        Dict[str, Any]: –û—Ç–≤–µ—Ç –æ—Ç Go —Å–µ—Ä–≤–µ—Ä–∞
            –û–±—ã—á–Ω–æ: {"status": "ok"} –∏–ª–∏ {"updated": true}

    Raises:
        RuntimeError: –ü—Ä–∏ –æ—à–∏–±–∫–∞—Ö HTTP, —Ç–∞–π–º–∞—É—Ç–∞—Ö, –ø—Ä–æ–±–ª–µ–º–∞—Ö Go —Å–µ—Ä–≤–µ—Ä–∞
        ValueError: –ï—Å–ª–∏ lot_db_id –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –≤ –ë–î

    Example:
        >>> update_lot_ai_results_sync(
        ...     lot_db_id="42",
        ...     category="–ú–æ—Å—Ç–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ",
        ...     ai_data={"cmu_table": [...], "smeta_summary": {...}},
        ...     processed_at="2024-12-16T14:30:00Z"
        ... )

    Note:
        - –í—ã–∑—ã–≤–∞–µ—Ç—Å—è –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ª–æ—Ç–∞ Gemini AI
        - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ Celery –∑–∞–¥–∞—á–∞—Ö (workers/gemini/tasks.py)
        - –ú–æ–∂–µ—Ç –±—ã—Ç—å –≤—ã–∑–≤–∞–Ω–∞ –ø–æ–≤—Ç–æ—Ä–Ω–æ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö
    """

    async def _async_update():
        client = GoApiClient()
        log.debug(f"–°–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –æ–±–µ—Ä—Ç–∫–∞: –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ AI —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –¥–ª—è –ª–æ—Ç–∞ {lot_db_id}")

        # –§–æ—Ä–º–∏—Ä—É–µ–º payload –≤ —Ñ–æ—Ä–º–∞—Ç–µ, –∫–æ—Ç–æ—Ä—ã–π –æ–∂–∏–¥–∞–µ—Ç Go-—Å–µ—Ä–≤–µ—Ä (—Å—Ç–∞—Ä—ã–π —Ñ–æ—Ä–º–∞—Ç)
        ai_payload = {
            "lot_key_parameters": {
                "ai": {
                    "source": "gemini",
                    "category": category,
                    "data": ai_data or {},
                    "processed_at": processed_at,
                }
            }
        }

        # –î–æ–±–∞–≤–ª—è–µ–º IDs –µ—Å–ª–∏ –æ–Ω–∏ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω—ã (–¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏)
        if tender_id:
            ai_payload["tender_id"] = str(tender_id)
        ai_payload["lot_id"] = str(lot_db_id)

        response = await client.update_lot_key_parameters(lot_db_id, ai_payload)

        log.info(f"‚úÖ AI —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –æ–±–Ω–æ–≤–ª–µ–Ω—ã –¥–ª—è –ª–æ—Ç–∞ {lot_db_id}")
        return response

    try:
        return run_async(_async_update())
    except Exception as e:
        log.exception(f"‚ùå –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è AI —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –¥–ª—è –ª–æ—Ç–∞ {lot_db_id}: {e}")
        raise RuntimeError(f"–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å AI —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã: {e}") from e
