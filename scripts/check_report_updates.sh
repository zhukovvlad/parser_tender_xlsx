#!/bin/bash

# ะกะบัะธะฟั ะดะปั ะฟัะพะฒะตัะบะธ ะพะฑะฝะพะฒะปะตะฝะธั ัะฐะนะปะพะฒ ะพััะตัะพะฒ
# ะัะฟะพะปัะทะพะฒะฐะฝะธะต: ./scripts/check_report_updates.sh <tender_id> <lot_id>
# ะัะธะผะตั: ./scripts/check_report_updates.sh 4 4

set -e

# ะฆะฒะตัะฐ ะดะปั ะฒัะฒะพะดะฐ
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

echo "=== ๐ ะัะพะฒะตัะบะฐ ะพะฑะฝะพะฒะปะตะฝะธั ัะฐะนะปะพะฒ ะพััะตัะพะฒ ==="
echo ""

TENDER_ID=$1
LOT_ID=$2

if [ -z "$TENDER_ID" ] || [ -z "$LOT_ID" ]; then
    echo -e "${RED}โ ะัะธะฑะบะฐ: ะะต ัะบะฐะทะฐะฝั ะฟะฐัะฐะผะตััั${NC}"
    echo ""
    echo "ะัะฟะพะปัะทะพะฒะฐะฝะธะต: $0 <tender_id> <lot_id>"
    echo "ะัะธะผะตั: $0 4 4"
    echo ""
    exit 1
fi

check_file() {
    local file=$1
    local label=$2
    
    echo -e "${YELLOW}๐ $label${NC}"
    
    if [ -f "$file" ]; then
        local mtime=$(stat -c '%y' "$file" 2>/dev/null || stat -f '%Sm' -t '%Y-%m-%d %H:%M:%S' "$file" 2>/dev/null)
        local size=$(stat -c '%s' "$file" 2>/dev/null || stat -f '%z' "$file" 2>/dev/null)
        local size_kb=$((size / 1024))
        
        echo -e "  ${GREEN}โ${NC} ะคะฐะนะป ัััะตััะฒัะตั: ${file}"
        echo "    ๐ ะะทะผะตะฝะตะฝ: ${mtime}"
        echo "    ๐ ะะฐะทะผะตั: ${size} ะฑะฐะนั (${size_kb} KB)"
        
        # ะัะพะฒะตััะตะผ, ะฑัะป ะปะธ ัะฐะนะป ะธะทะผะตะฝะตะฝ ะฒ ะฟะพัะปะตะดะฝะธะต 5 ะผะธะฝัั
        if [ "$(find "$file" -mmin -5 2>/dev/null)" ]; then
            echo -e "    ${GREEN}๐ ะะะะะะะ ะะะะะะะะ (ะผะตะฝะตะต 5 ะผะธะฝัั ะฝะฐะทะฐะด)${NC}"
        fi
    else
        echo -e "  ${RED}โ ะคะฐะนะป ะะ ัััะตััะฒัะตั: ${file}${NC}"
    fi
    echo ""
}

echo -e "${GREEN}ะัะพะฒะตัะบะฐ ัะฐะนะปะพะฒ ะดะปั:${NC}"
echo "  ะขะตะฝะดะตั ID: ${TENDER_ID}"
echo "  ะะพั ID: ${LOT_ID}"
echo ""
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo ""

# ะัะพะฒะตััะตะผ ะฒัะต ัะธะฟั ัะฐะนะปะพะฒ
check_file "tenders_positions/${TENDER_ID}_${LOT_ID}_positions.md" "Positions (ะดะตัะฐะปะธะทะฐัะธั ะดะปั AI)"
check_file "tenders_md_base/${TENDER_ID}_${LOT_ID}_base.md" "Base MD (ะฑะฐะทะพะฒัะน ะธะท JSON)"
check_file "tenders_md/${TENDER_ID}_${LOT_ID}.md" "Enhanced MD (ั AI ะดะฐะฝะฝัะผะธ)"
check_file "tenders_chunks/${TENDER_ID}_${LOT_ID}_chunks.json" "Chunks (ะดะปั ะฒะตะบัะพัะฝะพะณะพ ะฟะพะธัะบะฐ)"

echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo ""
echo -e "${YELLOW}๐ก ะะฝััััะบัะธั ะฟะพ ะฟัะพะฒะตัะบะต ะฟะพะฒัะพัะฝะพะน ะทะฐะณััะทะบะธ:${NC}"
echo ""
echo "1. ๐ ะะฐะฟะพะผะฝะธัะต ะฒัะตะผะตะฝะฐ ะธะทะผะตะฝะตะฝะธั ัะฐะนะปะพะฒ ะฒััะต"
echo "2. ๐ค ะะฐะณััะทะธัะต ัะพั ะถะต ัะตะฝะดะตั ะฟะพะฒัะพัะฝะพ ัะตัะตะท API:"
echo "   curl -X POST \"http://localhost:8000/parse-tender/\" \\"
echo "        -F \"file=@tender_${TENDER_ID}.xlsx\" \\"
echo "        -F \"enable_ai=false\""
echo ""
echo "3. โฑ๏ธ  ะะพะดะพะถะดะธัะต ะทะฐะฒะตััะตะฝะธั ะพะฑัะฐะฑะพัะบะธ"
echo "4. ๐ ะะฐะฟัััะธัะต ััะพั ัะบัะธะฟั ัะฝะพะฒะฐ:"
echo "   ./scripts/check_report_updates.sh ${TENDER_ID} ${LOT_ID}"
echo ""
echo "5. โ ะกัะฐะฒะฝะธัะต ะฒัะตะผะตะฝะฐ ะธะทะผะตะฝะตะฝะธั - ะพะฝะธ ะดะพะปะถะฝั ะพะฑะฝะพะฒะธัััั!"
echo ""
echo -e "${YELLOW}๐ ะะถะธะดะฐะตะผะพะต ะฟะพะฒะตะดะตะฝะธะต:${NC}"
echo "  - ะัะปะธ Go-ัะตัะฒะตั ะฒะตัะฝัะป ะขะะข ะะ ID โ ัะฐะนะปั ะะะะะะฏะขะกะฏ"
echo "  - ะัะปะธ Go-ัะตัะฒะตั ะฒะตัะฝัะป ะะะะซะ ID โ ัะพะทะดะฐะดัััั ะะะะซะ ัะฐะนะปั"
echo ""
echo -e "${YELLOW}๐ ะะพะดัะพะฑะฝะตะต: docs/REPORT_UPDATE_ISSUE.md${NC}"
echo ""
