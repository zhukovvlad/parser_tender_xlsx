from .get_proposals import get_proposals

def read_lots_and_boundaries(ws):
    """
    Извлекает информацию о лотах из листа Excel.

    Функция сканирует лист, начиная с 10-й строки и до последней.
    В каждой строке она проверяет значение в 4-й колонке (колонка D).
    Если значение в этой ячейке является строкой и начинается с "лот №"
    (без учета регистра), эта строка считается началом нового лота.

    Для каждого найденного лота собирается его название и информация
    о предложениях подрядчиков по этому лоту, которая получается путем вызова
    функции `get_proposals(ws)`. Важно отметить, что `get_proposals(ws)`
    вызывается с тем же объектом листа `ws` для каждого лота. Это означает,
    что либо `get_proposals` самостоятельно определяет, какие предложения
    относятся к текущему контексту (что не очевидно из ее сигнатуры),
    либо она возвращает все предложения с листа, и в таком случае каждый лот
    в результирующем словаре будет содержать один и тот же набор предложений.

    Args:
        ws (openpyxl.worksheet.worksheet.Worksheet): Лист Excel (объект openpyxl),
            с которого считываются данные о лотах.

    Returns:
        dict: Словарь, где:
            - Ключи (str): Идентификаторы лотов в формате "lot_X" (например, "lot_1",
              "lot_2", ...), где X - порядковый номер найденного лота.
            - Значения (dict): Словари, содержащие информацию по каждому лоту:
                - "lot_title" (str): Полное наименование лота, как оно указано
                  в 4-й колонке.
                - "proposals" (dict): Словарь с предложениями подрядчиков,
                  возвращаемый функцией `get_proposals(ws)`.

              Если лоты не найдены, возвращается пустой словарь.
    """
    last_row = ws.max_row  # Последняя строка на листе
    lots = {}  # Словарь для хранения информации о лотах
    index = 1  # Начальный индекс для нумерации лотов

    # Итерация по строкам, начиная с 10-й
    for i in range(10, last_row + 1):
        # Получаем значение из 4-й колонки (D) текущей строки
        lot_data = ws.cell(row=i, column=4).value

        # Проверяем, является ли значение строкой и начинается ли оно с "лот №"
        if isinstance(lot_data, str) and lot_data.lower().startswith("лот №"):
            # Если да, то это новый лот
            lots["lot_" + str(index)] = {
                "lot_title": lot_data,
                "proposals": get_proposals(ws) # Получаем предложения для этого лота
            }
            index += 1 # Увеличиваем индекс для следующего лота
            
    return lots