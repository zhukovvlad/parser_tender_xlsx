from .build_merged_shape_map import build_merged_shape_map

def read_contractors(ws):
    """
    Ищет на листе Excel строку, содержащую заголовки с наименованиями контрагентов,
    и извлекает информацию о каждой ячейке-заголовке контрагента из этой строки.

    Функция сканирует предопределенный диапазон строк (с 4-й по 10-ю включительно).
    Строка считается строкой заголовков контрагентов, если одна из ее ячеек
    содержит текст, начинающийся с "наименование контрагента" (без учета регистра
    и начальных/конечных пробелов).

    После нахождения такой строки, функция собирает информацию по каждой непустой
    ячейке в этой строке. Для каждой такой ячейки-заголовка определяется ее значение,
    координаты, начальная колонка, строка, а также информация об объединении ячеек,
    если она является частью объединенного диапазона (с использованием
    `build_merged_shape_map`).

    Args:
        ws (openpyxl.worksheet.worksheet.Worksheet): Лист Excel (объект openpyxl),
            на котором осуществляется поиск.

    Returns:
        list[dict] | None:
            - Список словарей, если строка заголовков контрагентов найдена.
              Каждый словарь в списке представляет одну ячейку-заголовок
              контрагента и содержит следующие ключи:
                - "value" (any): Значение из ячейки-заголовка (например, наименование
                                 контрагента).
                - "coordinate" (str): Координата ячейки (например, "D4").
                - "column_start" (int): Номер колонки ячейки (1-индексация).
                - "row_start" (int): Номер строки, в которой найдены заголовки
                                     контрагентов (1-индексация).
                - "merged_shape" (dict, optional): Если ячейка является частью
                                                   объединенного диапазона, этот ключ
                                                   будет содержать словарь вида
                                                   `{"rowspan": x, "colspan": y}`.
            - `None`, если строка заголовков контрагентов не найдена в диапазоне
              строк с 4 по 10.
    """
    prefix = "наименование контрагента"  # Искомый префикс в строке заголовков

    # Получаем карту всех объединенных ячеек на листе
    merged_map = build_merged_shape_map(ws)

    # Итерируемся по заданному диапазону строк (4-10) для поиска заголовков
    for row in ws.iter_rows(min_row=4, max_row=10):
        for cell in row:
            # Проверяем, содержит ли ячейка искомый префикс
            if isinstance(cell.value, str) and cell.value.strip().lower().startswith(prefix):
                # Если префикс найден, эта строка считается строкой заголовков контрагентов
                result = []
                # Собираем информацию о каждой непустой ячейке в этой найденной строке
                for c in row: # `c` - это ячейка в строке заголовков
                    if c.value is not None:
                        cell_info = {
                            "value": c.value,
                            "coordinate": c.coordinate,
                            "column_start": c.column,
                            "row_start": c.row, # Это будет номер строки, где найден prefix
                        }

                        # Если ячейка является частью объединенного диапазона, добавляем информацию об этом
                        if c.coordinate in merged_map:
                            cell_info["merged_shape"] = merged_map[c.coordinate]

                        result.append(cell_info)
                
                return result # Возвращаем список информации о ячейках-заголовках

    # Если ни одна строка в диапазоне не содержит искомый префикс
    return None